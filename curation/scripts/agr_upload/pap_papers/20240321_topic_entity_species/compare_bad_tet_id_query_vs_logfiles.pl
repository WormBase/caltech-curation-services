#!/usr/bin/env perl

# ABC prod was not working well and it wasn't taking the who/when we were sending.  compare the logs
# from 2025 08 02 until 20250913  against the prod output from
#
# select *
# from topic_entity_tag
# where created_by not like 'WBPerson%'
#   and created_by <> 'ACKnowledge_pipeline'
#   and created_by <> 'caltech_pipeline'
#   and entity_type = 'ATP:0000123'
#   and topic_entity_tag_source_id in (
#     select topic_entity_tag_source_id
#     from topic_entity_tag_source
#     where secondary_data_provider_id = (
#       select mod_id
#       from mod
#       where abbreviation = 'WB'
#     )
#   );
#
# to see what went into ABC prod with the wrong data, for Kimberly.  2025 09 25



use strict;
use diagnostics;
use DBI;
use JSON;
use Jex;
use Encode qw( from_to is_utf8 );
use Dotenv -load => '/usr/lib/.env';

my @tetids = qw( 396971 71150 238569 395066 395651 395642 395643 395645 395646 395652 395655 395644 395647 395649 395654 395653 395806 395807 396504 396507 396510 395648 396515 396520 396513 395650 396518 396523 396519 395640 395641 396505 396506 396508 396509 396511 396512 396514 396522 396516 396677 396678 396854 396857 396865 396870 396874 396853 396856 396864 396867 396873 396517 396859 396521 396868 396871 396524 396876 396855 396862 396863 396866 396858 396860 396861 396869 396872 396875 396877 395067 395075 395080 395085 395090 395095 395100 395105 395110 395074 395068 395070 395071 395072 395077 395082 395087 395092 395097 395102 395107 395073 395078 395083 395088 395093 395098 395103 395108 395079 395081 395084 395086 395089 395091 395094 395096 395099 395101 395104 395106 395109 395660 395069 395669 395674 395679 395684 395736 395661 395670 395675 395680 395685 395690 395695 395700 395708 395659 395713 395728 395733 395738 395743 395668 395673 395678 395683 395688 395689 395693 395664 395663 395667 395076 395672 395677 395682 395687 395692 395697 395702 395706 395656 395726 395731 395748 395662 395666 395671 395676 395681 395686 395691 395696 395701 395704 395707 395709 395658 395712 395727 395729 395732 395734 395737 395742 395747 395752 395757 395762 395767 395772 395694 395698 395699 395703 395705 395710 395715 395720 395725 395730 395735 395740 395745 395750 395755 395760 395765 395770 395775 395777 395780 395782 395785 395787 395790 395792 395795 395797 395800 395805 395739 395741 395744 395746 395749 395754 395759 395764 395769 395774 395779 395784 395789 395794 395799 395804 395751 395753 395756 395758 395761 395763 395766 395768 395771 395773 395776 395778 395781 395783 395786 395788 395791 395793 395796 395798 395801 395803 395802 396528 396532 396541 395717 396546 395722 396551 396556 396561 396566 396530 396527 395657 396531 395665 395711 396539 396540 395716 396525 396526 396534 396536 396533 396535 396537 396542 395718 396547 395723 396552 396557 396562 396567 396572 396577 396582 396587 396592 396597 396602 396607 396612 396617 396622 396627 396632 396634 396529 396637 396639 396642 396644 396647 396649 396654 396538 395714 396543 396544 395719 396548 395724 396553 396558 396563 396568 396573 396578 396583 396588 396593 396598 396603 396608 396613 396618 396623 396628 396633 396638 396641 396643 396646 396648 396651 396653 396656 396658 396545 395721 396550 396555 396560 396565 396570 396571 396575 396576 396580 396581 396585 396586 396590 396591 396595 396596 396600 396601 396605 396606 396610 396611 396615 396616 396620 396621 396625 396626 396630 396631 396549 396554 396559 396564 396569 396574 396579 396584 396589 396594 396599 396604 396609 396614 396619 396624 396629 396635 396640 396645 396650 396652 396655 396660 396665 396670 396675 396657 396659 396662 396664 396667 396669 396672 396674 396661 396663 396666 396668 396671 396673 396676 396879 396636 396890 396895 396900 396905 396910 396915 396920 396925 396931 396936 396941 396946 396878 396882 396886 396888 396893 396898 396903 396908 396913 396918 396923 396928 396933 396938 396943 396881 396883 396885 396887 396892 396897 396902 396907 396912 396917 396922 396927 396929 396934 396939 396944 396880 396884 396891 396896 396901 396906 396911 396916 396921 396926 396930 396935 396940 396945 396889 396894 396899 396904 396909 396914 396919 396924 396932 396937 396942 396947 );
my %queryIds;
foreach (@tetids) { $queryIds{$_}++; }

my %logIds;
my @dates = qw( 20250802 20250809 20250816 20250823 20250830 20250906 20250913 );

foreach my $date (@dates) {
  my $infile = 'cron_files/populate_species_topic_entity.api.prod.' . $date . '.api';
  open (IN, $infile) or die "Cannot open $infile : $!";
  while (my $line = <IN>) {
    if ($line =~ m/"New tag created successfully.","topic_entity_tag_id":(\d+)}/) { $logIds{$1}++; }
  }
  close (IN) or die "Cannot close $infile : $!";
}

# Find keys in %logIds not in %queryIds
my @only_in_log = sort { $a <=> $b } grep { !exists $queryIds{$_} } keys %logIds;

# Find keys in %queryIds not in %logIds
my @only_in_query = sort { $a <=> $b } grep { !exists $logIds{$_} } keys %queryIds;

# Output
print "Only in logIds: @only_in_log\n";
print "Only in queryIds: @only_in_query\n";

# {"status":"success","message":"New tag created successfully.","topic_entity_tag_id":396853}
# -rw-r--r-- 1 root root 263861 Aug  2 13:00 populate_species_topic_entity.api.prod.20250802.api


__END__

